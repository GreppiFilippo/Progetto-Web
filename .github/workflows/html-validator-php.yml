name: HTML validator (W3C vnu) â€” PHP site
on: [push, pull_request]

jobs:
  validate-html:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java (Temurin)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup PHP + composer (if needed)
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          coverage: none
          tools: composer: true

      - name: Optional: install PHP deps if composer.json exists
        if: ${{ always() }}
        run: |
          if [ -f composer.json ]; then
            composer install --no-interaction --no-progress --prefer-dist
          else
            echo "No composer.json, skipping composer install."
          fi

      - name: Download vnu (W3C validator)
        run: |
          curl -sL -o vnu.jar https://github.com/validator/validator/releases/latest/download/vnu.jar

      - name: Start PHP built-in server (uses ./www if present)
        run: |
          if [ -d ./www ]; then
            export DOCROOT=./www
          else
            export DOCROOT=.
          fi
          echo "Using docroot: $DOCROOT"
          php -S 127.0.0.1:8000 -t "$DOCROOT" >/dev/null 2>&1 &
          # give server time to start
          sleep 2

      - name: Build URL list (php/html)
        id: build_urls
        run: |
          DOCROOT=${DOCROOT:-./www}
          # fallback if DOCROOT not exported in this shell
          if [ ! -d "$DOCROOT" ]; then DOCROOT=.; fi
          find "$DOCROOT" -type f \( -name '*.php' -o -name '*.html' \) -not -path '*/node_modules/*' -print0 > files.txt || true
          if [ ! -s files.txt ]; then
            echo "no_files=true" >> $GITHUB_OUTPUT
            echo "::warning ::No PHP/HTML files found under $DOCROOT"
            exit 0
          fi
          # write URLs (trim leading ./ or $DOCROOT/)
          urls=()
          while IFS= read -r -d $'\0' f; do
            rel="${f#./}"
            rel="${rel#${DOCROOT}/}"
            urls+=("http://127.0.0.1:8000/${rel}")
          done < files.txt
          printf "%s\n" "${urls[@]}" > urls.txt
          echo "no_files=false" >> $GITHUB_OUTPUT
          echo "::set-output name=count::$(wc -l < urls.txt || true)"

      - name: Run W3C vnu validator (rendered pages) and produce JSON reports
        if: steps.build_urls.outputs.no_files != 'true'
        run: |
          mkdir -p validator-reports
          while IFS= read -r url; do
            # sanitize file name
            name=$(echo "$url" | sed -E 's|https?://||; s/[:/]/__|g')
            out="validator-reports/${name}.json"
            echo "Validating $url -> $out"
            java -jar vnu.jar --format json "$url" > "$out" || true
          done < urls.txt

          total=0
          for jf in validator-reports/*.json; do
            cnt=$(jq '.messages | length' "$jf" || echo 0)
            total=$((total + cnt))
          done

          if [ "$total" -gt 0 ]; then
            echo "Found $total validation message(s). Summary:"
            for jf in validator-reports/*.json; do
              echo "==> $jf"
              jq -r '.messages[]? | "\(.type): \(.message) (line:\(.lastLine) col:\(.firstColumn))"' "$jf" || true
            done
            exit 1
          else
            echo "No validation messages found."
          fi

      - name: Upload validator reports
        if: steps.build_urls.outputs.no_files != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: html-validator-reports
          path: validator-reports
